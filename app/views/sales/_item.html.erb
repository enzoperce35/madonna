<% if local_assigns.has_key? :identifier %>
  <% multi_id = ('multi' + identifier.to_s) %>
  <% prod_id = ('prod' + identifier.to_s) %>
  <% price_id = ('price' + identifier.to_s) %>
  <% up_id = ('up' + identifier.to_s) %>
  <% down_id = ('down' + identifier.to_s) %>
<% end %>

<tr>
  <td style="width: 5%;">
    <%= f.input_field :_destroy, as: :hidden %>
    <%= link_to '[X]', '#', class: 'remove_record', id: 'delete' %>
  </td>
  
  <td>
    <%= f.input :product, label: false, collection: Product.all.order(:name), input_html: {id: prod_id, class: 'tyi'} %><br>
  </td>
    
  <td style="width: 3%;"><div id=<%= down_id %> class="btn btn-warning multiplier">-</div></td>
  
  <td style="width: 5%;">
    <!--<%= f.number_field :multiplier, :id => multi_id, min: 0, max: 99 %>-->
    <%= f.input(:multiplier, label: false, as: :string, components: [:input], :wrapper => false, input_html: {id: multi_id} )%>
  </td>
  
  <td style="width: 3%;"><div id=<%= up_id %> class="btn btn-success multiplier">+</div></td>
  
  <td id= <%= price_id %> style="text-align:right" class="all-total"></td>
</tr>


<script>
  document.getElementById('<%= prod_id %>').focus();

  
  function showTotal() {
    var total = 0;
    document.querySelectorAll('.all-total').forEach(e => total += Number(e.innerHTML));
    
    return total;
  }
  
  var a = 1;
  function increase(partial_id){
    var total = showTotal();
    
    var prodIndex = Number(document.getElementById('prod' + partial_id).value) - 1;
    var prices = '<%= @products %>'.slice(1, -1).split(',');
    var price = Number(prices[prodIndex]);
    var multiplier = document.getElementById('multi' + partial_id);
    
    multiplier.value = a;
    a++;
    
    total += price;
    document.getElementById('grand-total').innerHTML = total;
    
    document.getElementById('price' + partial_id).innerHTML = price * multiplier.value;
  };

  function decrease(partial_id){
    var total = showTotal();
    
    var prodIndex = Number(document.getElementById('prod' + partial_id).value) - 1;
    var prices = '<%= @products %>'.slice(1, -1).split(',');
    var price = Number(prices[prodIndex]);
    var multiplier = document.getElementById('multi' + partial_id);

    multiplier.value = a-2;
    a--;

    total -= price;
    document.getElementById('grand-total').innerHTML = total;
    
    document.getElementById('price' + partial_id).innerHTML = price * multiplier.value
  }

  function inc_dec(attribute) {
    
    if (attribute.includes('up')) {
      partial_id = attribute.replace('up', '');
      
      increase(partial_id)
    }else {
      partial_id = attribute.replace('down', '');
      var multiplier = document.getElementById('multi' + partial_id);
      
      if (multiplier.value > 0) decrease(partial_id);
    };
  }
  
  
  var elements = document.getElementsByClassName("multiplier");

  var myFunction = function() {
    var attribute = this.getAttribute("id");
    
    inc_dec(attribute);
   };

   for (var i = 0; i < elements.length; i++) {
    elements[i].addEventListener('click', myFunction, false);
   }
</script>
